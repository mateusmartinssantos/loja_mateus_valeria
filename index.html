<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo MV - Promo√ß√µes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="./src/css/styles.css">
    <link rel="icon" type="image/x-icon" href="./src/img/favicon.ico">
    
    <style>
        /* Estilos para promo√ß√µes e melhorias */
        .price-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .current-price {
            font-weight: 700;
            font-size: 1.3rem;
            color: #e74c3c;
        }

        .original-price {
            font-size: 1rem;
            color: #7f8c8d;
            text-decoration: line-through;
        }

   

        .promo-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .product-card {
            position: relative;
        }

        .urgency-badge {
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .buy-now-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .buy-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        /* Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            position: relative;
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 1001;
        }

        .modal-nav-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        .modal-prev {
            left: 20px;
        }

        .modal-next {
            right: 20px;
        }

        .image-indicator {
            display: inline-block;
            margin-left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        #discount-row {
            display: none;
        }

        .product-description {
            margin: 8px 0;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* Vers√£o Details/Summary para descri√ß√£o */
        .descricao-detalhes {
            border: none;
        }

        .descricao-resumo {
            cursor: pointer;
            list-style: none;
            display: inline;
        }

        .descricao-resumo::-webkit-details-marker {
            display: none;
        }

        .descricao-curta {
            display: inline;
        }

        .ler-mais-texto {
            color: #3498db;
            font-weight: bold;
            margin-left: 4px;
            cursor: pointer;
        }

        .ler-mais-texto:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .descricao-completa {
            margin-top: 8px;
            display: block;
            color: #666;
        }

        /* Remove o estilo padr√£o do details */
        .descricao-detalhes[open] .ler-mais-texto {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõçÔ∏è Cat√°logo MV - PROMO√á√ïES</h1>
            <p>üéØ Ofertas especiais! Frete gr√°tis acima de R$ 50 ‚Ä¢ Descontos imperd√≠veis</p>
        </header>

        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar produtos...">
            </div>
            <div class="filter-box">
                <select id="categoryFilter">
                    <option value="all">Todas as categorias</option>
                </select>
            </div>
            <div class="cart-icon">
                <button class="btn btn-primary" onclick="scrollToOrderSection()">
                    <i class="fas fa-shopping-cart"></i> Ver Pedido
                    <span id="cartBadge" class="cart-badge" style="display: none;">0</span>
                </button>
            </div>
        </div>

        <div class="results-info" id="resultsInfo"></div>

        <div id="catalog">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando ofertas especiais...</p>
            </div>
        </div>

        <div id="pagination" class="pagination"></div>

        <div id="order-section">
            <h2><i class="fas fa-file-alt"></i> Resumo do Pedido</h2>
            <div class="order-actions">
                <button class="btn btn-secondary" onclick="generateOrderList()">
                    <i class="fas fa-sync-alt"></i> Atualizar Pedido
                </button>
                <button class="btn btn-danger" onclick="resetCart()">
                    <i class="fas fa-trash-alt"></i> Limpar Carrinho
                </button>
                <button class="btn btn-primary" onclick="copyOrderList()">
                    <i class="fas fa-copy"></i> Copiar Pedido
                </button>
                <button class="btn btn-success" onclick="sendOrder()">
                    <i class="fab fa-whatsapp"></i> Finalizar Compra
                </button>
            </div>
            <textarea id="order-list" placeholder="Seu pedido aparecer√° aqui..."></textarea>
            
            <div class="order-summary">
                <h3>Resumo Financeiro</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">R$ 0,00</span>
                </div>
                <div class="summary-row" id="discount-row">
                    <span>Descontos:</span>
                    <span id="discount">-R$ 0,00</span>
                </div>
                <div class="summary-row">
                    <span>Frete (gr√°tis acima de R$ 50):</span>
                    <span id="shipping">‚Äî</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total:</span>
                    <span id="total">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualiza√ß√£o de imagem -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="modalCaption" class="modal-caption"></div>
    </div>

    <script>
// CONFIGURA√á√ÉO
const GOOGLE_SHEET_ID = '1vp0CwpdOkHwkxIG1R68Vx0ZpTwpdv4FTJDqSRZ1th7I';
const SHEET_NAME = 'P√°gina1';
const WHATSAPP_NUMBER = '5511974176584';

// Estado da aplica√ß√£o
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
let cartItems = {};
const PRODUCTS_PER_PAGE = 20;

// Elementos DOM
const catalogElement = document.getElementById('catalog');
const paginationElement = document.getElementById('pagination');
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const resultsInfo = document.getElementById('resultsInfo');
const cartBadge = document.getElementById('cartBadge');
const orderListElement = document.getElementById('order-list');
const subtotalElement = document.getElementById('subtotal');
const discountElement = document.getElementById('discount');
const shippingElement = document.getElementById('shipping');
const totalElement = document.getElementById('total');
const discountRow = document.getElementById('discount-row');
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const modalCaption = document.getElementById('modalCaption');
const closeModal = document.querySelector('.close-modal');

// Vari√°veis para controle do modal
let currentImages = [];
let currentImageIndex = 0;

// --- FUN√á√ïES PRINCIPAIS ---

async function loadProducts() {
    try {
        catalogElement.innerHTML = `
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando ofertas especiais...</p>
            </div>
        `;

        const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        const response = await fetch(sheetUrl);
        const csvText = await response.text();
        
        allProducts = parseCSVToProducts(csvText);
        
        
        // Filtra produtos dispon√≠veis
        allProducts = allProducts.filter(product => product.disponivel > 0);
        
        filteredProducts = allProducts;
        
        populateCategoryFilter();
        updateResultsInfo();
        renderCatalog();
        
        // Carrega carrinho salvo
        const savedCart = localStorage.getItem('scrapbookCart');
        if (savedCart) {
            cartItems = JSON.parse(savedCart);
            updateCartBadge();
        }
        
    } catch (error) {
        
        catalogElement.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erro ao carregar o cat√°logo</h3>
                <p>Verifique a conex√£o.</p>
                <button class="btn btn-primary" onclick="loadProducts()">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
    }
}

function parseCSVToProducts(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
    
    const products = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length >= 7) {
            
            // Pre√ßo atual e original
            const precoAtual = parsePrice(values[4]);
            const precoOriginal = parsePrice(values[6]) || precoAtual;
            const disponivel = parseInt(values[5] || '0');
            const vendas = parseInt(values[7] || '0');

            // Calcula desconto
            const desconto = precoOriginal > precoAtual ? 
                Math.round(((precoOriginal - precoAtual) / precoOriginal) * 100) : 0;

            const product = {
                id: values[0] || `prod${i}`,
                nome: values[1] || 'Sem nome',
                descricao: values[2] || '',
                categoria: values[3] || 'Geral',
                preco: precoAtual,
                precoOriginal: precoOriginal,
                desconto: desconto,
                disponivel: disponivel,
                vendas: vendas,
                imagens: []
            };
            
            // Imagens (colunas a partir da 8)
            for (let j = 8; j < values.length; j++) {
                if (values[j] && values[j].trim()) {
                    const nomeImagem = values[j].trim();
                    if (nomeImagem && !nomeImagem.startsWith('http') && !nomeImagem.startsWith('/')) {
                        product.imagens.push(`src/img/${nomeImagem}`);
                    } else {
                        product.imagens.push(nomeImagem);
                    }
                }
            }
            
            if (product.imagens.length === 0) {
                product.imagens = ['data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9rPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2VtIEluZGlzcG9uw612ZWw8L3RleHQ+PC9zdmc+'];
            }
            
            products.push(product);
        }
    }
    
    return products;
}

function parsePrice(priceStr) {
    if (!priceStr) return 0;
    const clean = priceStr.toString().replace(/[^\d,.]/g, '');
    if (clean.includes(',')) {
        return parseFloat(clean.replace(',', '.'));
    }
    return parseFloat(clean) || 0;
}

function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    values.push(current.trim());
    return values.map(v => v.replace(/"/g, ''));
}

function populateCategoryFilter() {
    const categories = [...new Set(allProducts.map(p => p.categoria))];
    categoryFilter.innerHTML = '<option value="all">Todas as categorias</option>';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
    });
    
    // Adiciona op√ß√£o de promo√ß√µes
    const promoOption = document.createElement('option');
    promoOption.value = 'promocao';
    promoOption.textContent = 'Em Promo√ß√£o';
    categoryFilter.appendChild(promoOption);
}

function filterAndPaginate() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;

    filteredProducts = allProducts.filter(product => {
        const matchesSearch = product.nome.toLowerCase().includes(searchTerm) || 
                            (product.descricao && product.descricao.toLowerCase().includes(searchTerm));
        
        let matchesCategory = true;
        if (selectedCategory === 'promocao') {
            matchesCategory = product.desconto > 0;
        } else if (selectedCategory !== 'all') {
            matchesCategory = product.categoria === selectedCategory;
        }
        
        return matchesSearch && matchesCategory;
    });

    currentPage = 1;
    updateResultsInfo();
    renderCatalog();
}

function updateResultsInfo() {
    const totalProducts = filteredProducts.length;
    const promoCount = filteredProducts.filter(p => p.desconto > 0).length;
    
    if (totalProducts === 0) {
        resultsInfo.textContent = 'Nenhum produto encontrado';
    } else {
        resultsInfo.textContent = `${totalProducts} produto(s) ‚Ä¢ ${promoCount} em promo√ß√£o`;
    }
}

function renderCatalog() {
    if (filteredProducts.length === 0) {
        catalogElement.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>Nenhum produto encontrado</h3>
                <p>Tente alterar os filtros ou termos de busca.</p>
            </div>
        `;
        paginationElement.innerHTML = '';
        return;
    }

    catalogElement.innerHTML = '';
    
    const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
    const endIndex = startIndex + PRODUCTS_PER_PAGE;
    const productsToDisplay = filteredProducts.slice(startIndex, endIndex);

    productsToDisplay.forEach(product => {
        const availabilityClass = product.disponivel > 3 ? 'in-stock' : 
                                 product.disponivel > 0 ? 'low-stock' : 'out-of-stock';
        const availabilityIcon = product.disponivel > 3 ? 'fa-check-circle' : 
                                product.disponivel > 0 ? 'fa-exclamation-circle' : 'fa-times-circle';
        const availabilityText = product.disponivel > 3 ? `${product.disponivel} dispon√≠veis` : 
                                product.disponivel > 0 ? `√öltimas ${product.disponivel} unidades!` : 'Indispon√≠vel';

        const currentQty = cartItems[product.id] || 0;
        const hasMultipleImages = product.imagens && product.imagens.length > 1;
        const mainImage = product.imagens ? product.imagens[0] : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2VtIEluZGlzcG9uw612ZWw8L3RleHQ+PC9zdmc+';

        // Badge de promo√ß√£o
        const promoBadge = product.desconto > 0 ? 
            `<div class="promo-badge">-${product.desconto}% OFF</div>` : '';
        
        // Container de pre√ßo com original e atual
        const priceHTML = product.desconto > 0 ? `
            <div class="price-container">
                <span class="current-price">R$ ${product.preco.toFixed(2).replace('.', ',')}</span>
                <span class="original-price">R$ ${product.precoOriginal.toFixed(2).replace('.', ',')}</span>
                <span class="discount-badge">-${product.desconto}%</span>
            </div>
        ` : `
            <div class="product-price">R$ ${product.preco.toFixed(2).replace('.', ',')}</div>
        `;

        // Descri√ß√£o com sistema "Leia mais"
        const descricaoHTML = product.descricao ? `
            <div class="product-description">
                <details class="descricao-detalhes">
                    <summary class="descricao-resumo">
                        <span class="descricao-curta">
                            ${product.descricao.length > 60 ? product.descricao.substring(0, 60) + '...' : product.descricao}
                        </span>
                        ${product.descricao.length > 60 ? `<span class="ler-mais-texto">mais</span>` : ''}
                    </summary>
                    ${product.descricao.length > 60 ? `
                        <span class="descricao-completa">${product.descricao.substring(60)}</span>
                    ` : ''}
                </details>
            </div>
        ` : '';

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            ${promoBadge}
            <div class="product-image-container">
                <img src="${mainImage}" alt="${product.nome}" class="product-image" 
                     onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2VtIEluZGlzcG9uw612ZWw8L3RleHQ+PC9zdmc+'>
                <div class="zoom-icon">
                    <i class="fas fa-search-plus"></i>
                </div>
                ${hasMultipleImages ? `<div class="image-counter"><i class="fas fa-images"></i> ${product.imagens.length}</div>` : ''}
            </div>
            <div class="product-info">
                <div class="product-name">${product.nome} </div>
                ${descricaoHTML}
                <div class="product-id">C√≥d: ${product.id}</div>
                ${priceHTML}
                <div class="availability ${availabilityClass}">
                    <i class="fas ${availabilityIcon}"></i> ${availabilityText}
                </div>
                
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="changeQuantity('${product.id}', -1)" 
                            ${currentQty <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="qty-${product.id}" value="${currentQty}" min="0" 
                           max="${product.disponivel}" class="quantity-input"
                           data-price="${product.preco}" data-name="${product.nome}">
                    <button class="quantity-btn" onclick="changeQuantity('${product.id}', 1)" 
                            ${currentQty >= product.disponivel ? 'disabled' : ''}>
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <button class="buy-now-btn" onclick="addToCartAndHighlight('${product.id}')">
                    <i class="fas fa-bolt"></i> COMPRAR
                </button>
            </div>
        `;

        const imageContainer = card.querySelector('.product-image-container');
        imageContainer.addEventListener('click', () => {
            openImageModal(product);
        });

        catalogElement.appendChild(card);
    });
    
    renderPagination();
}
function scrollToOrderSection() {
    const orderSection = document.getElementById('order-section');
    
    if (Object.keys(cartItems).length === 0) {
        alert('Seu carrinho est√° vazio! Adicione produtos antes de ver o pedido.');
        return;
    }
    
    if (orderSection) {
        orderSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
        
        // Gera o pedido tamb√©m
        generateOrderList();
        
        // Efeito de destaque
        orderSection.style.boxShadow = '0 0 0 3px #3498db';
        setTimeout(() => {
            orderSection.style.boxShadow = '';
        }, 2000);
    }
}
function addToCartAndHighlight(productId) {
    changeQuantity(productId, 1);
    
    // Efeito visual de confirma√ß√£o
    const card = document.querySelector(`[onclick*="${productId}"]`).closest('.product-card');
    card.style.boxShadow = '0 0 0 3px #27ae60';
    setTimeout(() => {
        card.style.boxShadow = '';
    }, 1000);
}

function renderPagination() {
    paginationElement.innerHTML = '';
    const pageCount = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);

    if (pageCount <= 1) return;

    const prevButton = document.createElement('button');
    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        currentPage--;
        renderCatalog();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    paginationElement.appendChild(prevButton);

    for (let i = 1; i <= pageCount; i++) {
        if (i === 1 || i === pageCount || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = i === currentPage ? 'active' : '';
            button.onclick = () => {
                currentPage = i;
                renderCatalog();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            paginationElement.appendChild(button);
            
            if (i === 1 && currentPage > 3) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 5px';
                paginationElement.appendChild(ellipsis);
            } else if (i === currentPage + 1 && i < pageCount - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 5px';
                paginationElement.appendChild(ellipsis);
            }
        }
    }

    const nextButton = document.createElement('button');
    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextButton.disabled = currentPage === pageCount;
    nextButton.onclick = () => {
        currentPage++;
        renderCatalog();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    paginationElement.appendChild(nextButton);
}

function changeQuantity(productId, delta) {
    const input = document.getElementById(`qty-${productId}`);
    let currentQty = parseInt(input.value);
    const maxQty = parseInt(input.max);
    
    let newQty = currentQty + delta;
    
    if (newQty < 0) newQty = 0;
    if (newQty > maxQty) newQty = maxQty;
    
    input.value = newQty;
    
    if (newQty === 0) {
        delete cartItems[productId];
    } else {
        cartItems[productId] = newQty;
    }
    
    const minusBtn = input.previousElementSibling;
    const plusBtn = input.nextElementSibling;
    
    minusBtn.disabled = newQty <= 0;
    plusBtn.disabled = newQty >= maxQty;
    
    localStorage.setItem('scrapbookCart', JSON.stringify(cartItems));
    updateCartBadge();
}

function updateCartBadge() {
    const totalItems = Object.values(cartItems).reduce((sum, qty) => sum + qty, 0);
    
    if (totalItems > 0) {
        cartBadge.textContent = totalItems > 99 ? '99+' : totalItems;
        cartBadge.style.display = 'flex';
    } else {
        cartBadge.style.display = 'none';
    }
}

function generateOrderList() {
    let orderItems = [];
    let subtotal = 0;
    let totalDiscount = 0;
    let itemCount = 0;

    Object.keys(cartItems).forEach(productId => {
        const qty = cartItems[productId];
        if (qty > 0) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                const itemTotal = qty * product.preco;
                const itemDiscount = qty * (product.precoOriginal - product.preco);
                
                orderItems.push(`‚Ä¢ (C√≥d: ${product.id}) ${qty}x ${product.nome} - R$ ${itemTotal.toFixed(2).replace('.', ',')}`);
                subtotal += itemTotal;
                totalDiscount += itemDiscount > 0 ? itemDiscount : 0;
                itemCount += qty;
            }
        }
    });

    const shipping = subtotal >= 50 ? 0 : 10;
    const total = subtotal + shipping;

    // Atualiza resumo financeiro
    subtotalElement.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
    
    // Mostra/oculta linha de descontos
    if (totalDiscount > 0) {
        discountElement.textContent = `-R$ ${totalDiscount.toFixed(2).replace('.', ',')}`;
        discountRow.style.display = 'flex';
    } else {
        discountRow.style.display = 'none';
    }
    
    shippingElement.textContent = shipping === 0 ? 'GR√ÅTIS üéâ' : `R$ ${shipping.toFixed(2).replace('.', ',')}`;
    totalElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

    if (orderItems.length === 0) {
        orderListElement.value = "Seu carrinho est√° vazio. Adicione produtos ao carrinho antes de gerar o pedido.";
        return;
    }

    const now = new Date();
    const dateTime = now.toLocaleString('pt-BR');

    let listText = `üõçÔ∏è *PEDIDO - CAT√ÅLOGO MV* üõçÔ∏è\n`;
    listText += `üìÖ ${dateTime}\n\n`;
    listText += orderItems.join('\n');
    listText += `\n\n`;
    listText += `üìä *RESUMO:*\n`;
    listText += `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}\n`;
    if (totalDiscount > 0) {
        listText += `Descontos: -R$ ${totalDiscount.toFixed(2).replace('.', ',')}\n`;
    }
    listText += `Frete: ${shipping === 0 ? 'GR√ÅTIS üéâ' : 'R$ ' + shipping.toFixed(2).replace('.', ',')}\n`;
    listText += `*TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*\n\n`;
    listText += `Total de itens: ${itemCount}\n\n`;
    listText += `üîÑ *Status do Pedido:* ENVIADO\n`;
    listText += `‚è∞ *Data/Hora:* ${dateTime}\n\n`;
    listText += `Por favor, confirme a disponibilidade!\n\n`;
    listText += `üë§ *Dados do Cliente:*\n`;
    listText += `Nome: _________\n`;
    listText += `WhatsApp: _________\n`;
    listText += `üìç Endere√ßo: _________`;

    orderListElement.value = listText;
}

function sendOrder() {
    if (Object.keys(cartItems).length === 0) {
        alert('Seu carrinho est√° vazio! Adicione produtos antes de enviar o pedido.');
        return;
    }

    // Gera o pedido primeiro para mostrar o resumo
    generateOrderList();
    
    // Confirma√ß√£o com detalhes do pedido
    const itemCount = Object.values(cartItems).reduce((sum, qty) => sum + qty, 0);
    const subtotal = parseFloat(subtotalElement.textContent.replace('R$ ', '').replace(',', '.'));
    const total = parseFloat(totalElement.textContent.replace('R$ ', '').replace(',', '.'));
    
    const confirmationMessage = 
`Itens no pedido: ${itemCount}
Valor total: R$ ${total.toFixed(2).replace('.', ',')}
‚Ä¢ Seu pedido ser√° enviado para o WhatsApp
‚Ä¢ Os itens ser√£o reservados no estoque
‚Ä¢ Voc√™ receber√° instru√ß√µes de pagamento
Deseja continuar?`;

    if (!confirm(confirmationMessage)) {
        return; // Usu√°rio cancelou
    }

    // Baixa no estoque localmente
    updateStockAfterOrder();

    const listText = orderListElement.value;
    const whatsappMessage = encodeURIComponent(listText);
    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${whatsappMessage}`;
    
    // Abre WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // Feedback visual no pr√≥prio site
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Pedido Enviado!';
    btn.style.background = '#27ae60';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
    }, 3000);

    // Limpa carrinho ap√≥s envio
    setTimeout(() => {
        resetCartAfterOrder();
    }, 1000);
}
// COLE A URL DO SEU APPS SCRIPT AQUI (a que voc√™ copiou)
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyxP2BtR8b5M7sZ488nR4I5K1bF3u4aMgIho6UJLXJldbmkakfRal2PYfmK0D9Vm8MOQ/exec';

async function updateStockAfterOrder() {
    // Baixa no estoque localmente
    Object.keys(cartItems).forEach(productId => {
        const qty = cartItems[productId];
        if (qty > 0) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                product.disponivel -= qty;
                const filteredProduct = filteredProducts.find(p => p.id === productId);
                if (filteredProduct) {
                    filteredProduct.disponivel -= qty;
                }
            }
        }
    });

    // Atualiza estoque na planilha automaticamente
    try {
        const updates = {};
        Object.keys(cartItems).forEach(productId => {
            if (cartItems[productId] > 0) {
                updates[productId] = cartItems[productId];
            }
        });

        if (Object.keys(updates).length > 0) {
           
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    updates: updates
                })
            });
            renderCatalog();
            
        }
    } catch (error) {
        //console.error('‚ùå Erro ao atualizar estoque:', error);
        // Mesmo com erro, continua o processo
    }
}

function sendOrder() {
    if (Object.keys(cartItems).length === 0) {
        alert('Seu carrinho est√° vazio! Adicione produtos antes de enviar o pedido.');
        return;
    }

    // Gera o pedido primeiro para mostrar o resumo
    generateOrderList();
    
    // Confirma√ß√£o com detalhes do pedido
    const itemCount = Object.values(cartItems).reduce((sum, qty) => sum + qty, 0);
    const subtotal = parseFloat(subtotalElement.textContent.replace('R$ ', '').replace(',', '.'));
    const total = parseFloat(totalElement.textContent.replace('R$ ', '').replace(',', '.'));
    
    const confirmationMessage = 
`
Itens no pedido: ${itemCount}
Valor total: R$ ${total.toFixed(2).replace('.', ',')}

‚Ä¢ Pedido enviado para WhatsApp
‚Ä¢ Itens reservados no sistema
Deseja continuar?`;

    if (!confirm(confirmationMessage)) {
        return; // Usu√°rio cancelou
    }

    // Baixa no estoque localmente e na planilha
    updateStockAfterOrder();

    const listText = orderListElement.value;
    const whatsappMessage = encodeURIComponent(listText);
    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${whatsappMessage}`;
    
    // Abre WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // Feedback visual no pr√≥prio site
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Pedido Enviado!';
    btn.style.background = '#27ae60';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
    }, 3000);

    // Mostra confirma√ß√£o
    alert('‚úÖ Pedido enviado com sucesso!\n\n');

    // Limpa carrinho ap√≥s envio
    setTimeout(() => {
        resetCartAfterOrder();
    }, 2000);
}

// REMOVA estas fun√ß√µes se existirem (n√£o s√£o mais necess√°rias):
// generateManualStockReport()
// copyStockReportToClipboard()
// copyToClipboard()
   
function copyStockReportToClipboard(text) {
    // Cria um elemento tempor√°rio para copiar
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        document.execCommand('copy');
        //console.log('üìã Relat√≥rio copiado para √°rea de transfer√™ncia!');
    } catch (err) {
        //console.log('‚ùå N√£o foi poss√≠vel copiar o relat√≥rio automaticamente');
        //console.log('üìã Relat√≥rio completo:', text);
    }
    
    document.body.removeChild(textarea);
}

function resetCartAfterOrder() {
    // Limpa carrinho mas mant√©m o pedido gerado por um tempo
    const savedOrder = orderListElement.value;
    
    cartItems = {};
    localStorage.removeItem('scrapbookCart');
    updateCartBadge();
    
    // Atualiza o cat√°logo para refletir novo estoque
    renderCatalog();
    
    // Mant√©m o pedido vis√≠vel por mais 5 segundos
    setTimeout(() => {
        if (Object.keys(cartItems).length === 0) {
            orderListElement.value = "Pedido enviado com sucesso! \n\nObrigado pela compra. Em breve entraremos em contato pelo WhatsApp.";
        }
    }, 5000);
}

function resetCart() {
    if (Object.keys(cartItems).length === 0) {
        alert('O carrinho j√° est√° vazio!');
        return;
    }
    
    if (confirm('Tem certeza que deseja limpar o carrinho? Todos os itens ser√£o removidos.')) {
        cartItems = {};
        localStorage.removeItem('scrapbookCart');
        updateCartBadge();
        renderCatalog();
        generateOrderList();
        alert('Carrinho limpo com sucesso!');
    }
}

function copyOrderList() {
    orderListElement.select();
    orderListElement.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        const originalText = orderListElement.placeholder;
        orderListElement.placeholder = "Pedido copiado para a √°rea de transfer√™ncia!";
        setTimeout(() => {
            orderListElement.placeholder = originalText;
        }, 2000);
    } catch (err) {
        //console.error('Falha ao copiar texto: ', err);
        alert('N√£o foi poss√≠vel copiar o pedido. Selecione e copie manualmente.');
    }
}

function openImageModal(product) {
    currentImages = product.imagens || ['data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2VtIEluZGlzcG9uw612ZWw8L3RleHQ+PC9zdmc+'];
    currentImageIndex = 0;
    
    imageModal.style.display = "block";
    modalImage.src = currentImages[0];
    modalCaption.innerHTML = product.nome;
    
    updateModalControls();
    document.body.style.overflow = 'hidden';
}

function updateModalControls() {
    // Remove controles anteriores
    const existingPrevBtn = document.getElementById('modalPrevBtn');
    const existingNextBtn = document.getElementById('modalNextBtn');
    const existingIndicator = document.querySelector('.image-indicator');
    if (existingPrevBtn) existingPrevBtn.remove();
    if (existingNextBtn) existingNextBtn.remove();
    if (existingIndicator) existingIndicator.remove();
    
    // Se tiver m√∫ltiplas imagens, adiciona controles
    if (currentImages.length > 1) {
        // Bot√£o anterior
        const prevBtn = document.createElement('button');
        prevBtn.id = 'modalPrevBtn';
        prevBtn.className = 'modal-nav-btn modal-prev';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.onclick = (e) => {
            e.stopPropagation();
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            modalImage.src = currentImages[currentImageIndex];
            updateModalControls();
        };
        imageModal.appendChild(prevBtn);
        
        // Bot√£o pr√≥ximo
        const nextBtn = document.createElement('button');
        nextBtn.id = 'modalNextBtn';
        nextBtn.className = 'modal-nav-btn modal-next';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = (e) => {
            e.stopPropagation();
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            modalImage.src = currentImages[currentImageIndex];
            updateModalControls();
        };
        imageModal.appendChild(nextBtn);
        
        // Indicador
        const imageIndicator = document.createElement('div');
        imageIndicator.className = 'image-indicator';
        imageIndicator.innerHTML = `${currentImageIndex + 1} / ${currentImages.length}`;
        modalCaption.appendChild(imageIndicator);
    }
}

// Event Listeners
closeModal.addEventListener('click', function() {
    imageModal.style.display = "none";
    document.body.style.overflow = 'auto';
});

imageModal.addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = "none";
        document.body.style.overflow = 'auto';
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (imageModal.style.display === 'block') {
            imageModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
});

// INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', loadProducts);

searchInput.addEventListener('input', filterAndPaginate);
categoryFilter.addEventListener('change', filterAndPaginate);

let searchTimeout;
searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterAndPaginate, 300);
});

    </script>
</body>
</html>