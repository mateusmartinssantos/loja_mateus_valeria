<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="./src/css/styles.css">
    <link rel="icon" type="image/x-icon" href="./src/img/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./src/img/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="src/img/apple-touch-icon.png">
    <style>
    /* CSS básico para teste */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }
    .modal-content {
        position: relative;
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        top: 50%;
        transform: translateY(-50%);
    }
    .close-modal {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-palette"></i> Catálogo MV</h1>
            <p>Encontre diversos produtos. Faça seu pedido diretamente pelo WhatsApp!</p>
        </header>

        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar produtos...">
            </div>
            <div class="filter-box">
                <select id="categoryFilter">
                    <option value="all">Todas as categorias</option>
                </select>
            </div>
            <div class="cart-icon">
                <button class="btn btn-primary" onclick="generateOrderList()">
                    <i class="fas fa-shopping-cart"></i> Ver Pedido
                </button>
                <span id="cartBadge" class="cart-badge" style="display: none;">0</span>
            </div>
        </div>

        <div class="results-info" id="resultsInfo"></div>

        <div id="catalog">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando produtos...</p>
            </div>
        </div>

        <div id="pagination" class="pagination"></div>

        <div id="order-section">
            <h2><i class="fas fa-file-alt"></i> Resumo do Pedido</h2>
            <div class="order-actions">
                <button class="btn btn-secondary" onclick="generateOrderList()">
                    <i class="fas fa-sync-alt"></i> Atualizar Pedido
                </button>
                <button class="btn btn-danger" onclick="resetCart()">
                    <i class="fas fa-trash-alt"></i> Limpar Carrinho
                </button>
                <button class="btn btn-primary" onclick="copyOrderList()">
                    <i class="fas fa-copy"></i> Copiar Pedido
                </button>
                <a id="whatsappLink" class="btn btn-success" target="_blank">
                    <i class="fab fa-whatsapp"></i> Enviar no WhatsApp
                </a>
            </div>
            <textarea id="order-list" placeholder="Seu pedido aparecerá aqui..."></textarea>
            
            <div class="order-summary">
                <h3>Resumo Financeiro</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">R$ 0,00</span>
                </div>
                <div class="summary-row">
                    <span>Frete (a combinar):</span>
                    <span>—</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total estimado:</span>
                    <span id="total">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualização de imagem -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="modalCaption" class="modal-caption"></div>
    </div>

    <script>
// CONFIGURAÇÃO - EDITE AQUI!
const GOOGLE_SHEET_ID = '1VpdN6kkVCwsT_zJKJSX5MsmDh-g6xcag_LwJXjETJl8'; // Ex: 1XyZ123abc...
const SHEET_NAME = 'Página1'; // Nome da aba da planilha
const WHATSAPP_NUMBER = '5511974176584';

// Estado da aplicação
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
let cartItems = {};
const PRODUCTS_PER_PAGE = 20;

// Elementos DOM
const catalogElement = document.getElementById('catalog');
const paginationElement = document.getElementById('pagination');
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const resultsInfo = document.getElementById('resultsInfo');
const cartBadge = document.getElementById('cartBadge');
const orderListElement = document.getElementById('order-list');
const whatsappLink = document.getElementById('whatsappLink');
const subtotalElement = document.getElementById('subtotal');
const totalElement = document.getElementById('total');
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const modalCaption = document.getElementById('modalCaption');
const closeModal = document.querySelector('.close-modal');

// Variáveis para controle do modal
let currentImages = [];
let currentImageIndex = 0;

// --- FUNÇÕES PRINCIPAIS ---

// Carrega os produtos do Google Sheets
async function loadProducts() {
    try {
        catalogElement.innerHTML = `
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando produtos do catálogo...</p>
            </div>
        `;

        // URL pública da planilha (formato CSV)
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        
        const response = await fetch(sheetUrl);
        const csvText = await response.text();
        
        // Converte CSV para JSON
        allProducts = parseCSVToProducts(csvText);
        console.log('Produtos carregados:', allProducts);
        
        // FILTRA APENAS PRODUTOS DISPONÍVEIS (estoque > 0)
        allProducts = allProducts.filter(product => product.disponivel > 0);
        
        filteredProducts = allProducts;
        
        populateCategoryFilter();
        updateResultsInfo();
        renderCatalog();
        
        // Carrega o carrinho do localStorage
        const savedCart = localStorage.getItem('scrapbookCart');
        if (savedCart) {
            cartItems = JSON.parse(savedCart);
            updateCartBadge();
        }
        
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        catalogElement.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erro ao carregar o catálogo</h3>
                <p>Verifique a conexão ou configure a planilha.</p>
                <button class="btn btn-primary" onclick="loadProducts()">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
    }
}

// Converte CSV para array de produtos
// Converte CSV para array de produtos
function parseCSVToProducts(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
    
    const products = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length >= 6) { // Mínimo de colunas necessárias
            const product = {
                id: values[0] || `prod${i}`,
                nome: values[1] || 'Sem nome',
                descricao: values[2] || '',
                categoria: values[3] || 'Geral',
                preco: parseFloat(values[4]) || 0,
                disponivel: parseInt(values[5]) || 0,
                imagens: []
            };
            
            // Adiciona imagens das colunas 6 em diante
            for (let j = 6; j < values.length; j++) {
                if (values[j] && values[j].trim()) {
                    const nomeImagem = values[j].trim();
                    // Se for apenas o nome do arquivo, adiciona o caminho completo
                    if (nomeImagem && !nomeImagem.startsWith('http') && !nomeImagem.startsWith('/')) {
                        product.imagens.push(`src/img/${nomeImagem}`);
                    } else {
                        product.imagens.push(nomeImagem);
                    }
                }
            }
            
            // Se não tiver imagens, usa placeholder
            if (product.imagens.length === 0) {
                product.imagens = ['https://via.placeholder.com/300x200?text=Imagem+Indisponível'];
            }
            
            products.push(product);
        }
    }
    
    return products;
}

// Parse correto de linha CSV
function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current.trim());
    return values.map(v => v.replace(/"/g, ''));
}

function populateCategoryFilter() {
    const categories = [...new Set(allProducts.map(p => p.categoria))];
    categoryFilter.innerHTML = '<option value="all">Todas as categorias</option>';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
    });
}

function filterAndPaginate() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;

    filteredProducts = allProducts.filter(product => {
        const matchesSearch = product.nome.toLowerCase().includes(searchTerm) || 
                            (product.descricao && product.descricao.toLowerCase().includes(searchTerm));
        const matchesCategory = selectedCategory === 'all' || product.categoria === selectedCategory;
        return matchesSearch && matchesCategory;
    });

    currentPage = 1;
    updateResultsInfo();
    renderCatalog();
}

function updateResultsInfo() {
    const totalProducts = filteredProducts.length;
    const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE + 1;
    const endIndex = Math.min(currentPage * PRODUCTS_PER_PAGE, totalProducts);
    
    if (totalProducts === 0) {
        resultsInfo.textContent = 'Nenhum produto encontrado';
    } else if (totalProducts <= PRODUCTS_PER_PAGE) {
        resultsInfo.textContent = `Mostrando ${totalProducts} produto(s)`;
    } else {
        resultsInfo.textContent = `Mostrando ${startIndex}-${endIndex} de ${totalProducts} produto(s)`;
    }
}

function renderCatalog() {
    if (filteredProducts.length === 0) {
        catalogElement.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>Nenhum produto encontrado</h3>
                <p>Tente alterar os filtros ou termos de busca.</p>
            </div>
        `;
        paginationElement.innerHTML = '';
        return;
    }

    catalogElement.innerHTML = '';
    
    const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
    const endIndex = startIndex + PRODUCTS_PER_PAGE;
    const productsToDisplay = filteredProducts.slice(startIndex, endIndex);

    productsToDisplay.forEach(product => {
        const availabilityClass = product.disponivel > 10 ? 'in-stock' : 
                                 product.disponivel > 0 ? 'low-stock' : 'out-of-stock';
        const availabilityIcon = product.disponivel > 10 ? 'fa-check-circle' : 
                                product.disponivel > 0 ? 'fa-exclamation-circle' : 'fa-times-circle';
        const availabilityText = product.disponivel > 10 ? `Disponível: ${product.disponivel}` : 
                                product.disponivel > 0 ? `Poucas unidades: ${product.disponivel}` : 'Indisponível';

        const currentQty = cartItems[product.id] || 0;
        
        const hasMultipleImages = product.imagens && product.imagens.length > 1;
        const mainImage = product.imagens ? product.imagens[0] : 'https://via.placeholder.com/300x200';

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <div class="product-image-container">
                <img src="${mainImage}" alt="${product.nome}" class="product-image" 
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/240x200?text=Imagem+Não+Disponível'">
                <div class="zoom-icon">
                    <i class="fas fa-search-plus"></i>
                </div>
                ${hasMultipleImages ? `<div class="image-counter"><i class="fas fa-images"></i> ${product.imagens.length}</div>` : ''}
            </div>
            <div class="product-info">
                <div class="product-name">${product.nome}</div>
                ${product.descricao ? `<div class="product-description">${product.descricao}</div>` : ''}
                <div class="product-id">Cód: ${product.id}</div>
                <div class="product-price">R$ ${product.preco.toFixed(2).replace('.', ',')}</div>
                <div class="availability ${availabilityClass}">
                    <i class="fas ${availabilityIcon}"></i> ${availabilityText}
                </div>
                
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="changeQuantity('${product.id}', -1)" 
                            ${currentQty <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="qty-${product.id}" value="${currentQty}" min="0" 
                           max="${product.disponivel}" class="quantity-input"
                           data-price="${product.preco}" data-name="${product.nome}">
                    <button class="quantity-btn" onclick="changeQuantity('${product.id}', 1)" 
                            ${currentQty >= product.disponivel ? 'disabled' : ''}>
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `;

        const imageContainer = card.querySelector('.product-image-container');
        imageContainer.addEventListener('click', () => {
            openImageModal(product);
        });

        catalogElement.appendChild(card);
    });
    
    renderPagination();
}

function renderPagination() {
    paginationElement.innerHTML = '';
    const pageCount = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);

    if (pageCount <= 1) return;

    const prevButton = document.createElement('button');
    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        currentPage--;
        renderCatalog();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    paginationElement.appendChild(prevButton);

    for (let i = 1; i <= pageCount; i++) {
        if (i === 1 || i === pageCount || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = i === currentPage ? 'active' : '';
            button.onclick = () => {
                currentPage = i;
                renderCatalog();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            paginationElement.appendChild(button);
            
            if (i === 1 && currentPage > 3) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 5px';
                paginationElement.appendChild(ellipsis);
            } else if (i === currentPage + 1 && i < pageCount - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 5px';
                paginationElement.appendChild(ellipsis);
            }
        }
    }

    const nextButton = document.createElement('button');
    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextButton.disabled = currentPage === pageCount;
    nextButton.onclick = () => {
        currentPage++;
        renderCatalog();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    paginationElement.appendChild(nextButton);
}

function changeQuantity(productId, delta) {
    const input = document.getElementById(`qty-${productId}`);
    let currentQty = parseInt(input.value);
    const maxQty = parseInt(input.max);
    
    let newQty = currentQty + delta;
    
    if (newQty < 0) newQty = 0;
    if (newQty > maxQty) newQty = maxQty;
    
    input.value = newQty;
    
    if (newQty === 0) {
        delete cartItems[productId];
    } else {
        cartItems[productId] = newQty;
    }
    
    const minusBtn = input.previousElementSibling;
    const plusBtn = input.nextElementSibling;
    
    minusBtn.disabled = newQty <= 0;
    plusBtn.disabled = newQty >= maxQty;
    
    localStorage.setItem('scrapbookCart', JSON.stringify(cartItems));
    updateCartBadge();
}

function updateCartBadge() {
    const totalItems = Object.values(cartItems).reduce((sum, qty) => sum + qty, 0);
    
    if (totalItems > 0) {
        cartBadge.textContent = totalItems > 99 ? '99+' : totalItems;
        cartBadge.style.display = 'flex';
    } else {
        cartBadge.style.display = 'none';
    }
}

function generateOrderList() {
    let orderItems = [];
    let subtotal = 0;
    let itemCount = 0;

    Object.keys(cartItems).forEach(productId => {
        const qty = cartItems[productId];
        if (qty > 0) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                const itemTotal = qty * product.preco;
                orderItems.push(`• ${qty}x ${product.nome} - R$ ${itemTotal.toFixed(2).replace('.', ',')}`);
                subtotal += itemTotal;
                itemCount += qty;
            }
        }
    });

    subtotalElement.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
    totalElement.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;

    if (orderItems.length === 0) {
        orderListElement.value = "Seu carrinho está vazio. Adicione produtos ao carrinho antes de gerar o pedido.";
        whatsappLink.href = "#";
        whatsappLink.classList.remove('btn-success');
        whatsappLink.classList.add('btn-secondary');
        return;
    }

    let listText = `Olá! Gostaria de fazer o pedido de produto(s):\n\n`;
    listText += orderItems.join('\n');
    listText += `\n\n`;
    listText += `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}\n`;
    listText += `Total de itens: ${itemCount}\n\n`;
    listText += `Por favor, confirme a disponibilidade e informe as formas de pagamento e entrega.\n\n`;
    listText += `Nome: \n`;
    listText += `WhatsApp: \n`;
    listText += `Endereço para entrega:`;

    orderListElement.value = listText;
    
    const whatsappMessage = encodeURIComponent(listText);
    whatsappLink.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${whatsappMessage}`;
    whatsappLink.classList.remove('btn-secondary');
    whatsappLink.classList.add('btn-success');
    
    document.getElementById('order-section').scrollIntoView({ behavior: 'smooth' });
}

function copyOrderList() {
    orderListElement.select();
    orderListElement.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        const originalText = orderListElement.placeholder;
        orderListElement.placeholder = "Pedido copiado para a área de transferência!";
        setTimeout(() => {
            orderListElement.placeholder = originalText;
        }, 2000);
    } catch (err) {
        console.error('Falha ao copiar texto: ', err);
        alert('Não foi possível copiar o pedido. Selecione e copie manualmente.');
    }
}

function resetCart() {
    if (Object.keys(cartItems).length === 0) {
        alert('O carrinho já está vazio!');
        return;
    }
    
    if (confirm('Tem certeza que deseja limpar o carrinho? Todos os itens serão removidos.')) {
        cartItems = {};
        localStorage.removeItem('scrapbookCart');
        updateCartBadge();
        renderCatalog();
        generateOrderList();
        alert('Carrinho limpo com sucesso!');
    }
}

function openImageModal(product) {
    currentImages = product.imagens || ['https://via.placeholder.com/300x200'];
    currentImageIndex = 0;
    
    imageModal.style.display = "block";
    modalImage.src = currentImages[0];
    modalCaption.innerHTML = product.nome;
    
    updateModalControls();
    document.body.style.overflow = 'hidden';
}

function updateModalControls() {
    const existingPrevBtn = document.getElementById('modalPrevBtn');
    const existingNextBtn = document.getElementById('modalNextBtn');
    const existingIndicator = document.querySelector('.image-indicator');
    if (existingPrevBtn) existingPrevBtn.remove();
    if (existingNextBtn) existingNextBtn.remove();
    if (existingIndicator) existingIndicator.remove();
    
    if (currentImages.length > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.id = 'modalPrevBtn';
        prevBtn.className = 'modal-nav-btn modal-prev';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.onclick = (e) => {
            e.stopPropagation();
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            modalImage.src = currentImages[currentImageIndex];
            updateModalControls();
        };
        imageModal.appendChild(prevBtn);
        
        const nextBtn = document.createElement('button');
        nextBtn.id = 'modalNextBtn';
        nextBtn.className = 'modal-nav-btn modal-next';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = (e) => {
            e.stopPropagation();
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            modalImage.src = currentImages[currentImageIndex];
            updateModalControls();
        };
        imageModal.appendChild(nextBtn);
        
        const imageIndicator = document.createElement('div');
        imageIndicator.className = 'image-indicator';
        imageIndicator.innerHTML = `${currentImageIndex + 1} / ${currentImages.length}`;
        modalCaption.appendChild(imageIndicator);
    }
}

// Event Listeners
closeModal.addEventListener('click', function() {
    imageModal.style.display = "none";
    document.body.style.overflow = 'auto';
});

imageModal.addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = "none";
        document.body.style.overflow = 'auto';
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (imageModal.style.display === 'block') {
            imageModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
});

// INICIALIZAÇÃO
document.addEventListener('DOMContentLoaded', loadProducts);

searchInput.addEventListener('input', filterAndPaginate);
categoryFilter.addEventListener('change', filterAndPaginate);

let searchTimeout;
searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterAndPaginate, 300);
});
    </script>
</body>

</html>

